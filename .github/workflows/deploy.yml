name: Deploy

on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: "Branch ou tag a ser implantada"
        required: false
        default: "main"
  workflow_run:
    workflows: ["CI"]
    branches: ["main"]
    types:
      - completed

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    name: Deploy production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://app.consorcioliderenergy.com.br
    permissions:
      contents: read

    env:
      DB_HOST: ${{ secrets.PROD_DB_HOST }}
      DB_NAME: ${{ secrets.PROD_DB_NAME }}
      DB_USERNAME: ${{ secrets.PROD_DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
      APP_KEY: ${{ secrets.PROD_APP_KEY }}
      JWT_SECRET: ${{ secrets.PROD_JWT_SECRET }}
      USER_CELESC: ${{secrets.PROD_USER_CELESC}}
      PASSWORD_CELESC: ${{secrets.PROD_PASSWORD_CELESC}}

    steps:
      - name: Determinar ref para deploy
        id: resolve_ref
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REF="${{ inputs.git_ref }}"
            if [ -z "$REF" ]; then
              REF="main"
            fi
            echo "checkout_ref=$REF" >> "$GITHUB_OUTPUT"
          else
            echo "checkout_ref=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
            echo "deploy_branch=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve_ref.outputs.checkout_ref || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core==2.16.5 ansible-lint==24.5.0 jmespath

      - name: Install Ansible collections
        working-directory: ansible
        run: ansible-galaxy collection install -r collections/requirements.yml --force

      - name: Configure Ansible Vault (optional)
        env:
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -n "${ANSIBLE_VAULT_PASSWORD:-}" ]; then
            mkdir -p ~/.ansible
            printf '%s\n' "$ANSIBLE_VAULT_PASSWORD" > ~/.ansible/vault-pass.txt
            chmod 600 ~/.ansible/vault-pass.txt
            echo "ANSIBLE_VAULT_PASSWORD_FILE=$HOME/.ansible/vault-pass.txt" >> "$GITHUB_ENV"
          else
            echo "Variável ANSIBLE_VAULT_PASSWORD não configurada; utilizando variáveis de ambiente em vez do vault."
            if [ -f ansible/group_vars/all/vault.yml ]; then
              mv ansible/group_vars/all/vault.yml ansible/group_vars/all/vault.yml.disabled
            fi
          fi
          
      - name: Configure SSH keys
        env:
          BASTION_SSH_KEY: ${{ secrets.BASTION_SSH_KEY }}
          PROD_DEPLOY_SSH_KEY: ${{ secrets.PROD_DEPLOY_SSH_KEY }}
        run: |
          set -eo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          if [ -z "${BASTION_SSH_KEY:-}" ]; then
            echo "Secret BASTION_SSH_KEY não está configurado" >&2
            exit 1
          fi

          if [ -z "${PROD_DEPLOY_SSH_KEY:-}" ]; then
            echo "Secret PROD_DEPLOY_SSH_KEY não está configurado" >&2
            exit 1
          fi

          printf '%s\n' "$BASTION_SSH_KEY" > ~/.ssh/bastion.pem
          printf '%s\n' "$PROD_DEPLOY_SSH_KEY" > ~/.ssh/deploy.pem
          chmod 600 ~/.ssh/bastion.pem ~/.ssh/deploy.pem

          # ProxyCommand configurado no inventário ainda aponta para este caminho.
          cp ~/.ssh/bastion.pem /tmp/key_nopass.pem
          chmod 600 /tmp/key_nopass.pem
  
          for host in 5.161.237.241 178.156.188.174; do
            ssh-keyscan -H "$host" >> ~/.ssh/known_hosts 2>/dev/null || true
          done

      - name: Run Ansible deploy
        env:
          ANSIBLE_CONFIG: ${{ github.workspace }}/ansible/ansible.cfg
          ANSIBLE_PRIVATE_KEY_FILE: ~/.ssh/deploy.pem
        run: |
          ansible-playbook ansible/deploy.yml \
            --extra-vars "deploy_branch=${{ steps.resolve_ref.outputs.deploy_branch }}" \
            --inventory ansible/inventory.ini
