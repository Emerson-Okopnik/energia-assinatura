---
- hosts: app
  serial: 1
  become: true
  vars:
    app_path: /var/www/energia-assinatura/current
    api_domain: api.consorcioliderenergy.com.br
    frontend_origin: https://app.consorcioliderenergy.com.br
    php_fpm_service: php8.2-fpm
    release_path: "{{ app_path }}"
    repo_path: "{{ app_root }}/repo"
    nginx_configure_frontend: false
    backend_requires_nodejs: true
  pre_tasks:
    - name: Garantir diretórios base
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"
      loop:
        - "{{ app_root }}"
        - "{{ app_root }}/shared"
        - "{{ app_root }}/shared/storage"
        - "{{ app_root }}/shared/bootstrap/cache"
  roles:
    - role: common
    - role: php
    - role: backend
    - role: nginx
    - role: schedule
  post_tasks:
    - name: Garantir aplicação de handlers pendentes
      ansible.builtin.meta: flush_handlers

- hosts: frontend
  serial: 1
  become: true
  vars:
    release_path: "{{ app_root }}/frontend"
    repo_path: "{{ app_root }}/repo"
  pre_tasks:
    - name: Garantir diretórios base do frontend
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"
      loop:
        - "{{ app_root }}"
        - "{{ repo_path | dirname }}"
        - "{{ release_path }}"
        - "{{ frontend_root }}"
  roles:
    - role: common
    - role: frontend
    - role: nginx
  post_tasks: